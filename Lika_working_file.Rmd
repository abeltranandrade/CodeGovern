---
title: "Lika working file"
author: "Lika Mikhelashvili"
date: "2022-11-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(stringr)
library("htmltools")
library("xml2")
library(tidyverse)
library(readr, include.only = 'read_csv')
#install.packages("rjson")
library(rjson)
library(XML)
library(methods)
```

```{r}
GetDataGovFiles <- function(name_vector, import = TRUE){
  prefix <- "https://catalog.data.gov/dataset"
  #Specific name needs to be lowercase and with dashes between words
  for(name in name_vector){
    specific <- tolower(name)
    specific <- gsub(" ", "-", specific)
    # paste the prefix and name together with a slash and no spaces
    full_url <- paste0(prefix,"/", specific, sep = "")
    #Ensure that dataset requested exists
    tryCatch(
      expr = {html <- read_html(full_url)},
      error = function(e){          # Specifying error message
        message("There was an error. The dataset was not found")
      }
    )
    #get HTML of the name given
    html <- read_html(full_url)
  
    # creating the XML command to find the data they are looking for
    first <- ".//a[@data-format='"
    last <- "']"
    typeTogether <- paste0(first, "csv", last)
    print(typeTogether)
  
    #https://stackoverflow.com/questions/45256789/get-value-from-xml-with-r-by-attribute
    #find the xml that is a link with data-format attribute of the type asked
    final <- xml_find_all(html, typeTogether)
    final <- html_attr(final, 'href')
    print(final)
    
    name <- gsub(" ", "", name)
    filename <- str_c(name, ".", "csv")
  
    if(import){
      # CSV file
      tryCatch(
        expr = {
            download.file(url = final, destfile = filename, overwrite = T)
            return(read_csv(filename, locale=locale(encoding="latin1")))
           #
        },
        warning = function(w){  # Specifying warning message
          #message("Redirecting")
          message(paste0("Redirecting to this page: ", final))
          browseURL(final)
        }
      )
    }
    return(1)
  }
}

```

```{r}
my_names <- c("FDIC Failed Bank List", "Demographic Statistics By Zip Code")
GetDataGovFiles(my_names, import = TRUE)
```


```{r}
#files <- c("Electric Vehicle Population Data", "Lottery Powerball Winning Numbers: Beginning 2010")
#GetDataGovFiles <- function(name_vector, import = TRUE){
#  return(map(files, get_gov_file(..., "csv", import=TRUE)))
#}

my_name <- "Electric Vehicle Population Data"
data1<- GetDataGovFiles(my_name, import = TRUE)

name2<- "Crime Data from 2020 to Present"
data2<- GetDataGovFiles(name2, import = TRUE)

```






